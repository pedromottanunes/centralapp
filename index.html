<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Configura√ß√µes</title>
  <meta name="viewport" content="width=375, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      width: 100%;
      max-width: 375px;
      margin: 0 auto 90px auto;
      background: #f8f9fa;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 90%;
      margin: 28px 0 18px 0;
    }
    .settings-title {
      font-size: 2rem;
      font-weight: 600;
      color: #222;
      letter-spacing: 0.1px;
      transition: color 0.2s;
    }
    .profile-pic {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #fff;
      box-shadow: 0 2px 8px #e4e4e4;
      transition: box-shadow 0.2s;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      width: 90%;
      margin: 0 auto 32px auto;
    }
    .settings-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 8px 0 rgba(75,0,160,0.07);
      padding: 22px 0 12px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: box-shadow .13s;
      cursor: pointer;
      position: relative;
      min-height: 90px;
      user-select: none;
    }
    .settings-card.no-func {
      cursor: default;
      opacity: 0.78;
    }
    .settings-card:hover:not(.no-func) {
      box-shadow: 0 4px 18px 0 rgba(75,0,160,0.12);
    }
    .settings-card .icon {
      width: 40px;
      height: 40px;
      margin-bottom: 12px;
      background: #7e44e6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.6rem;
      box-shadow: 0 2px 8px #ebe1ff;
    }
    .settings-card .label {
      font-size: 1rem;
      color: #252525;
      font-weight: 500;
      letter-spacing: 0.02em;
      text-align: center;
    }
    /* Bottom nav bar */
    .bottom-nav {
      width: 100%;
      max-width: 375px;
      margin: 0 auto;
      background: #fff;
      height: 64px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 0 16px;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 -2px 18px #eee;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      z-index: 10;
    }
    .bottom-nav .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #b4aee8;
      font-size: 1.5rem;
      padding-top: 8px;
    }
    .bottom-nav .nav-btn.active {
      color: #7e44e6;
    }
    .bottom-nav .nav-center-btn {
      background: #7e44e6;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 50%;
      transform: translateX(-50%) translateY(-22px);
      color: #fff;
      font-size: 2rem;
      box-shadow: 0 6px 24px #ede3fe;
      border: 6px solid #fff;
      z-index: 2;
    }
    /* Modal */
    .modal-bg {display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.45); z-index: 99; justify-content: center; align-items: center;}
    .modal-bg.open { display: flex;}
    .modal-main {background: #fff; padding: 28px 24px 24px 24px; border-radius: 20px; box-shadow: 0 2px 24px 0 rgba(40,70,140,0.15);
            min-width: 280px; min-height: 170px; display: flex; flex-direction: column; align-items: center; gap: 16px; position: relative; max-width: 95vw;}
    .close-btn { position: absolute; right: 14px; top: 14px; background: transparent; border: none; font-size: 1.5rem; color: #888; cursor: pointer;}
    .btn-main, .btn-sub {
      background: #3576f6;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 11px 22px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin: 8px 0;
      box-shadow: 0 2px 8px 0 rgba(53,118,246,0.10);
      transition: background 0.2s, transform 0.1s;
    }
    .btn-main:hover, .btn-sub:hover { background: #2254a6;}
    .audio-player {width: 100%; margin-top: 10px;}
    .status-msg {font-size: 1rem; color: #2254a6; margin-top: 5px;}
    .file-list {max-height: 250px; overflow-y: auto; width: 100%; padding: 0 4px;}
    .file-list ul {list-style: none; padding: 0; margin: 0;}
    .file-list li {margin-bottom: 10px;}
    .file-list .del-btn { color: #c00; border: none; background: none; font-size: 1.1rem; margin-left: 8px; cursor: pointer;}
    .hidden {display: none;}
    @media (max-width: 400px) {
      .container, .bottom-nav { max-width: 100vw; }
      .settings-title { font-size: 1.3rem; }
      .settings-grid { gap: 10px; }
      .settings-card { padding: 15px 0 10px 0; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="settings-header">
      <span class="settings-title" id="settingsTitle">Configura√ß√µes</span>
      <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Foto de Perfil" class="profile-pic" id="profilePic">
    </div>
    <div class="settings-grid">
      <div class="settings-card" onclick="abrirModalGravador()">
        <div class="icon">‚ìò</div>
        <div class="label">Informa√ß√µes do Perfil</div>
      </div>
      <div class="settings-card no-func">
        <div class="icon">üîí</div>
        <div class="label">Senha</div>
      </div>
      <div class="settings-card" onclick="abrirModalPDF()">
        <div class="icon">‚úâÔ∏è</div>
        <div class="label">E-mail (PDF)</div>
      </div>
      <div class="settings-card" onclick="abrirModalAudios()">
        <div class="icon">üìû</div>
        <div class="label">Telefone (√Åudios)</div>
      </div>
      <div class="settings-card no-func">
        <div class="icon">üîî</div>
        <div class="label">Notifica√ß√µes</div>
      </div>
      <div class="settings-card no-func">
        <div class="icon">$</div>
        <div class="label">Moeda</div>
      </div>
      <div class="settings-card no-func">
        <div class="icon">üåê</div>
        <div class="label">Idioma</div>
      </div>
      <div class="settings-card" onclick="abrirModalProjetos()">
        <div class="icon">üë§</div>
        <div class="label">Conta (Projetos)</div>
      </div>
      <div class="settings-card" onclick="abrirModalLogin()">
        <div class="icon">üõ°Ô∏è</div>
        <div class="label" id="loginLabel">Pol√≠tica de Privacidade (Login Google)</div>
      </div>
      <div class="settings-card no-func">
        <div class="icon">‚ùì</div>
        <div class="label">Termos de Uso</div>
      </div>
    </div>
  </div>
  <nav class="bottom-nav">
    <div class="nav-btn"><span>üè†</span></div>
    <div class="nav-btn"><span>üìÅ</span></div>
    <div class="nav-center-btn"><span>ü§ñ</span></div>
    <div class="nav-btn"><span>‚è∞</span></div>
    <div class="nav-btn"><span>‚öôÔ∏è</span></div>
  </nav>

  <!-- Modais -->
  <!-- Modal Gravador de √Åudio -->
  <div class="modal-bg" id="modalGravador">
    <div class="modal-main">
      <button class="close-btn" onclick="fecharModalGravador()">&times;</button>
      <h3>Gravador de √Åudio</h3>
      <div class="gravador-btns">
        <button id="btnGravar" class="btn-main" onclick="iniciarGravacao()">‚è∫Ô∏è Gravar</button>
        <button id="btnPausar" class="btn-sub" onclick="pausarGravacao()" disabled>‚è∏Ô∏è Pausar</button>
        <button id="btnParar" class="btn-sub" onclick="pararGravacao()" disabled>‚èπÔ∏è Parar</button>
      </div>
      <audio id="audioPlayer" class="audio-player" controls style="display:none;"></audio>
      <button id="btnUpload" class="btn-main" style="width:100%;display:none;" onclick="salvarNoDriveResumable()">Salvar no Google Drive</button>
      <div id="statusMsg" class="status-msg"></div>
    </div>
  </div>
  <!-- Modal Upload PDF -->
  <div class="modal-bg" id="modalPDF">
    <div class="modal-main">
      <button class="close-btn" onclick="fecharModalPDF()">&times;</button>
      <h3>Upload de Projeto (PDF)</h3>
      <input type="file" id="inputPdf" accept="application/pdf" style="margin-bottom:16px;">
      <div id="pdfFileName" style="font-size:1rem; color:#2254a6;"></div>
      <button id="btnUploadPdf" class="btn-main" style="width:100%; display:none;" onclick="salvarPdfNoDrive()">Salvar PDF no Google Drive</button>
      <div id="statusMsgPdf" class="status-msg"></div>
    </div>
  </div>
  <!-- Modal Listar √Åudios -->
  <div class="modal-bg" id="modalAudios">
    <div class="modal-main">
      <button class="close-btn" onclick="fecharModalAudios()">&times;</button>
      <h3>√Åudios enviados</h3>
      <div class="file-list"><div id="listaArquivosReunioesUsuario"></div></div>
      <div id="statusMsgReunioes" class="status-msg"></div>
    </div>
  </div>
  <!-- Modal Listar Projetos -->
  <div class="modal-bg" id="modalProjetos">
    <div class="modal-main">
      <button class="close-btn" onclick="fecharModalProjetos()">&times;</button>
      <h3>Projetos enviados</h3>
      <div class="file-list"><div id="listaArquivosProjetosUsuario"></div></div>
      <div id="statusMsgProjetos" class="status-msg"></div>
    </div>
  </div>
  <!-- Modal Login Google -->
  <div class="modal-bg" id="modalLogin">
    <div class="modal-main">
      <button class="close-btn" onclick="fecharModalLogin()">&times;</button>
      <h3>Autentica√ß√£o Google</h3>
      <div id="authStatus" class="status-msg"></div>
      <button id="btnGoogleAuth" class="btn-main" onclick="googleSignIn()">Login Google</button>
      <button id="btnGoogleOut" class="btn-main" onclick="googleSignOut()" style="display:none;">Sair do Google</button>
      <div id="userEmail" style="margin-top: 10px; color: #2c62a6;"></div>
    </div>
  </div>

<script>
/* --- CONFIGURA√á√ïES --- */
const MAX_AUDIO_CHUNK = 23 * 1024 * 1024; // 23 MB
const CLIENT_ID = '206253858878-rdmme43csja9vuicd6uh4so1cgfg3v0u.apps.googleusercontent.com';
const API_KEY = 'AIzaSyDSQt5SOwfXOKuMasPUShacyHmsjzObDnA';
const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
const PASTA_ATAS_ID = '13LyjSc_52aYD6Tr1JsDd266fDLNbUj4A';
const PASTA_RELATORIOS_ID = '1Q-xMsOfm47M0kuyS0AdKSmDt5J0D4UAK';
const PASTA_ATAS_AUTOMATIZADAS_ID = '1DyW_xNYZAppz6tHabxOJBGkbfC67weoZ';
const PASTA_RELATORIOS_AUTOMATIZADOS_ID = '1hxKM8pr6gjw66-Fm0zGfDuYvZ_BkYjFO';

let accessToken = '';
let tokenClient = null;
let userEmail = '';
let userPic = '';
/* --- LOGIN GOOGLE --- */
window.onload = function() {
    gapi.load('client', () => {
        gapi.client.init({apiKey: API_KEY});
    });
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: handleTokenResponse,
    });
};

function googleSignIn() {
    tokenClient.requestAccessToken();
}
function handleTokenResponse(tokenResponse) {
    if (tokenResponse && tokenResponse.access_token) {
        accessToken = tokenResponse.access_token;
        document.getElementById('authStatus').textContent = "Google Drive conectado.";
        document.getElementById('btnGoogleAuth').style.display = 'none';
        document.getElementById('btnGoogleOut').style.display = '';
        getUserEmail();
    } else {
        document.getElementById('authStatus').textContent = "Erro na autentica√ß√£o.";
    }
}
function googleSignOut() {
    accessToken = '';
    document.getElementById('authStatus').textContent = "Fa√ßa login para salvar no Google Drive.";
    document.getElementById('btnGoogleAuth').style.display = '';
    document.getElementById('btnGoogleOut').style.display = 'none';
    document.getElementById('userEmail').textContent = '';
    // Volta foto/t√≠tulo original
    document.getElementById('profilePic').src = "https://randomuser.me/api/portraits/women/44.jpg";
    document.getElementById('profilePic').alt = "Foto de Perfil";
    document.getElementById('settingsTitle').textContent = "Configura√ß√µes";
}
async function getUserEmail() {
    if (!accessToken) return;
    try {
        const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: {'Authorization': 'Bearer ' + accessToken}
        });
        const data = await resp.json();
        if (data.picture) {
            document.getElementById('profilePic').src = data.picture;
            document.getElementById('profilePic').alt = "Foto do usu√°rio";
        }
        if (data.name) {
            document.getElementById('settingsTitle').textContent = data.name;
        }
        if (data.email) {
            document.getElementById('userEmail').textContent = data.email;
        }
    } catch (e) {}
}

/* --- MODAIS --- */
function abrirModalGravador() { document.getElementById('modalGravador').classList.add('open'); resetarGravador(); }
function fecharModalGravador() { document.getElementById('modalGravador').classList.remove('open'); resetarGravador(); }
function abrirModalPDF() { document.getElementById('modalPDF').classList.add('open'); resetarLerProjeto(); }
function fecharModalPDF() { document.getElementById('modalPDF').classList.remove('open'); resetarLerProjeto(); }
function abrirModalAudios() { document.getElementById('modalAudios').classList.add('open'); listarArquivosReunioes(); }
function fecharModalAudios() { document.getElementById('modalAudios').classList.remove('open'); document.getElementById('listaArquivosReunioesUsuario').innerHTML = ""; document.getElementById('statusMsgReunioes').textContent = ""; }
function abrirModalProjetos() { document.getElementById('modalProjetos').classList.add('open'); listarArquivosProjetos(); }
function fecharModalProjetos() { document.getElementById('modalProjetos').classList.remove('open'); document.getElementById('listaArquivosProjetosUsuario').innerHTML = ""; document.getElementById('statusMsgProjetos').textContent = ""; }
function abrirModalLogin() { document.getElementById('modalLogin').classList.add('open'); }
function fecharModalLogin() { document.getElementById('modalLogin').classList.remove('open'); }

/* --- GRAVADOR DE √ÅUDIO --- */
let mediaRecorder, audioChunks = [], audioBlob;
const btnGravar = document.getElementById('btnGravar');
const btnPausar = document.getElementById('btnPausar');
const btnParar = document.getElementById('btnParar');
const audioPlayer = document.getElementById('audioPlayer');
const btnUpload = document.getElementById('btnUpload');
const statusMsg = document.getElementById('statusMsg');
let audioBlobGlobal = null;
function iniciarGravacao() {
    if (!navigator.mediaDevices || !window.MediaRecorder) {
        alert("Seu navegador n√£o suporta grava√ß√£o de √°udio!");
        return;
    }
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.onstart = () => {
            btnGravar.disabled = true;
            btnPausar.disabled = false;
            btnParar.disabled = false;
            statusMsg.textContent = 'Gravando...';
            audioPlayer.style.display = 'none';
            btnUpload.style.display = 'none';
        };
        mediaRecorder.onpause = () => { statusMsg.textContent = 'Grava√ß√£o pausada.'; };
        mediaRecorder.onresume = () => { statusMsg.textContent = 'Gravando...'; };
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            convertToMp3WithProcessing(audioBlob).then(mp3Blob => {
                audioPlayer.src = URL.createObjectURL(mp3Blob);
                audioPlayer.style.display = 'block';
                btnUpload.style.display = 'block';
                statusMsg.textContent = 'Grava√ß√£o finalizada. Clique em \"Salvar no Google Drive\".';
                audioBlobGlobal = mp3Blob;
            }).catch((err) => {
                console.error(\"Erro na convers√£o/processamento:\", err);
                statusMsg.textContent = 'Falha na convers√£o para MP3.';
                audioBlobGlobal = audioBlob;
            });
        };
        mediaRecorder.start();
    }).catch(err => {
        statusMsg.textContent = 'Erro ao acessar o microfone: ' + err.message;
        alert('Erro ao acessar o microfone: ' + err.message);
    });
}
function pausarGravacao() {
    if (!mediaRecorder) return;
    if (mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        btnPausar.textContent = "‚ñ∂Ô∏è Retomar";
        statusMsg.textContent = 'Grava√ß√£o pausada.';
    } else if (mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
        btnPausar.textContent = "‚è∏Ô∏è Pausar";
        statusMsg.textContent = 'Gravando...';
    }
}
function pararGravacao() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        btnGravar.disabled = false;
        btnPausar.disabled = true;
        btnPausar.textContent = "‚è∏Ô∏è Pausar";
        btnParar.disabled = true;
    }
}
function resetarGravador() {
    btnGravar.disabled = false;
    btnPausar.disabled = true;
    btnPausar.textContent = "‚è∏Ô∏è Pausar";
    btnParar.disabled = true;
    audioPlayer.src = "";
    audioPlayer.style.display = 'none';
    btnUpload.style.display = 'none';
    statusMsg.textContent = '';
    audioBlobGlobal = null;
}
function convertToMp3WithProcessing(webmBlob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function () {
            const arrayBuffer = this.result;
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.decodeAudioData(arrayBuffer).then(audioBuffer => {
                // ==== PROCESSAMENTO ====
                const offlineCtx = new OfflineAudioContext(
                    1, audioBuffer.length, audioBuffer.sampleRate
                );
                let input;
                if (audioBuffer.numberOfChannels > 1) {
                    const left = audioBuffer.getChannelData(0);
                    const right = audioBuffer.getChannelData(1);
                    const mono = offlineCtx.createBuffer(1, audioBuffer.length, audioBuffer.sampleRate);
                    const monoData = mono.getChannelData(0);
                    for (let i = 0; i < audioBuffer.length; i++) {
                        monoData[i] = 0.5 * (left[i] + right[i]);
                    }
                    input = offlineCtx.createBufferSource();
                    input.buffer = mono;
                } else {
                    input = offlineCtx.createBufferSource();
                    input.buffer = audioBuffer;
                }
                const highpass = offlineCtx.createBiquadFilter();
                highpass.type = "highpass";
                highpass.frequency.value = 100;
                const lowpass = offlineCtx.createBiquadFilter();
                lowpass.type = "lowpass";
                lowpass.frequency.value = 9000;
                const gain = offlineCtx.createGain();
                gain.gain.value = 2.5;
                input.connect(highpass);
                highpass.connect(lowpass);
                lowpass.connect(gain);
                gain.connect(offlineCtx.destination);
                input.start();
                offlineCtx.startRendering().then(processedBuffer => {
                    const samples = processedBuffer.getChannelData(0);
                    const sampleRate = processedBuffer.sampleRate;
                    const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, 96);
                    const intSamples = new Int16Array(samples.length);
                    for (let i = 0; i < samples.length; i++) {
                        intSamples[i] = Math.max(-32768, Math.min(32767, samples[i] * 32767));
                    }
                    const maxSamples = 1152;
                    let mp3Data = [];
                    for (let i = 0; i < intSamples.length; i += maxSamples) {
                        const sampleChunk = intSamples.subarray(i, i + maxSamples);
                        const mp3buf = mp3Encoder.encodeBuffer(sampleChunk);
                        if (mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
                    }
                    const endBuf = mp3Encoder.flush();
                    if (endBuf.length > 0) mp3Data.push(new Int8Array(endBuf));
                    const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
                    resolve(mp3Blob);
                }).catch(reject);
            }).catch(reject);
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(webmBlob);
    });
}
function splitBlob(blob, partSize) {
    const parts = [];
    let offset = 0;
    while (offset < blob.size) {
        const end = Math.min(offset + partSize, blob.size);
        parts.push(blob.slice(offset, end, blob.type));
        offset = end;
    }
    return parts;
}
/* --- SALVAR √ÅUDIO NO GOOGLE DRIVE --- */
async function salvarNoDriveResumable() {
    if (!accessToken) { alert("Voc√™ precisa conectar com o Google Drive antes."); return; }
    if (!audioBlobGlobal) { alert("Nenhum √°udio para enviar."); return; }
    statusMsg.textContent = "Processando √°udio para upload...";
    const partes = splitBlob(audioBlobGlobal, MAX_AUDIO_CHUNK);
    for (let i = 0; i < partes.length; i++) {
        const parte = partes[i];
        const parteNum = i + 1;
        statusMsg.textContent = `Enviando parte ${parteNum} de ${partes.length}...`;
        const metadata = {
            name: `audio_reuniao_${getNextFileNumber('audio')}_parte${parteNum}.mp3`,
            mimeType: parte.type,
            parents: [PASTA_ATAS_ID]
        };
        const start = await fetch(
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&fields=id",
            {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + accessToken,
                    "Content-Type": "application/json; charset=UTF-8",
                    "X-Upload-Content-Type": parte.type
                },
                body: JSON.stringify(metadata)
            }
        );
        const uploadURL = start.headers.get("Location");
        if (!uploadURL) {
            statusMsg.textContent = "Falha ao criar sess√£o para parte " + parteNum;
            return;
        }
        const put = await fetch(uploadURL, {
            method: "PUT",
            headers: {
                "Content-Type": parte.type,
                "Content-Length": parte.size,
                "Content-Range": `bytes 0-${parte.size - 1}/${parte.size}`
            },
            body: parte
        });
        if (put.ok) {
            const file = await put.json();
            statusMsg.innerHTML += `<br>Parte ${parteNum} enviada! <a href=\"https://drive.google.com/file/d/${file.id}/view\" target=\"_blank\">Abrir</a>`;
        } else {
            statusMsg.textContent = "Erro ao enviar parte " + parteNum + ": " + put.status;
            return;
        }
    }
    statusMsg.innerHTML += "<br>Upload conclu√≠do! Todas as partes foram enviadas.";
}
function getNextFileNumber(tipo) {
    const key = 'contador_' + tipo;
    let n = Number(localStorage.getItem(key)) || 1;
    localStorage.setItem(key, n + 1);
    return n;
}
/* --- UPLOAD PDF --- */
const inputPdf = document.getElementById('inputPdf');
const pdfFileName = document.getElementById('pdfFileName');
const btnUploadPdf = document.getElementById('btnUploadPdf');
const statusMsgPdf = document.getElementById('statusMsgPdf');
let pdfBlobGlobal = null;
function resetarLerProjeto() {
    inputPdf.value = "";
    pdfFileName.textContent = "";
    btnUploadPdf.style.display = 'none';
    statusMsgPdf.textContent = "";
    pdfBlobGlobal = null;
}
inputPdf.onchange = function() {
    const file = inputPdf.files[0];
    if (file && file.type === "application/pdf") {
        pdfFileName.textContent = "Selecionado: " + file.name;
        btnUploadPdf.style.display = 'block';
        pdfBlobGlobal = file;
    } else {
        pdfFileName.textContent = "Selecione um arquivo PDF v√°lido.";
        btnUploadPdf.style.display = 'none';
        pdfBlobGlobal = null;
    }
};
async function salvarPdfNoDrive() {
    if (!accessToken) {
        alert("Voc√™ precisa conectar com o Google Drive antes de salvar.");
        return;
    }
    if (!pdfBlobGlobal) {
        alert("Nenhum PDF selecionado.");
        return;
    }
    statusMsgPdf.textContent = 'Enviando PDF para o Google Drive...';
    const metadata = {
        name: pdfBlobGlobal.name,
        parents: [PASTA_RELATORIOS_ID]
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', pdfBlobGlobal);
    try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: form,
        });
        const result = await response.json();
        if(result.id){
            statusMsgPdf.innerHTML = 'PDF enviado! <a href=\"https://drive.google.com/file/d/' + result.id + '/view\" target=\"_blank\">Abrir arquivo</a>';
        }else{
            statusMsgPdf.textContent = 'Falha ao enviar: ' + (result.error && result.error.message ? result.error.message : 'Erro desconhecido');
        }
    } catch(e){
        statusMsgPdf.textContent = 'Erro na conex√£o com o Google Drive.';
    }
}
/* --- LISTAR √ÅUDIOS/PROJETOS --- */
async function listarArquivosReunioes() {
    if (!accessToken) {
        document.getElementById('statusMsgReunioes').textContent = 'Conecte com o Google Drive.';
        return;
    }
    document.getElementById('statusMsgReunioes').textContent = 'Carregando arquivos...';
    async function buscarArquivos(pastaId) {
        const url = `https://www.googleapis.com/drive/v3/files?q='${pastaId}' in parents&fields=files(id,name,mimeType,webViewLink,createdTime)&orderBy=createdTime desc&supportsAllDrives=true&includeItemsFromAllDrives=true`;
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } });
        const data = await resp.json();
        return data.files || [];
    }
    try {
        const arquivosUsuario = await buscarArquivos(PASTA_ATAS_ID);
        let htmlUsuario = '<ul>';
        arquivosUsuario.forEach(arq => {
            let icon = arq.mimeType.startsWith("audio/") ? "üéµ" : "üìÑ";
            htmlUsuario += `<li>
                ${icon} <a href=\"${arq.webViewLink}\" target=\"_blank\">${arq.name}</a>
                <span style=\"color:#9bbdfa; font-size:0.92rem;\"> (${new Date(arq.createdTime).toLocaleString()})</span>
                <button onclick=\"excluirArquivoDrive('${arq.id}', this)\" title=\"Excluir\" class=\"del-btn\">üóëÔ∏è</button>
            </li>`;
        });
        htmlUsuario += '</ul>';
        document.getElementById('listaArquivosReunioesUsuario').innerHTML = htmlUsuario;
        document.getElementById('statusMsgReunioes').textContent = '';
    } catch (e) {
        document.getElementById('statusMsgReunioes').textContent = 'Erro ao buscar arquivos.';
    }
}
async function listarArquivosProjetos() {
    if (!accessToken) {
        document.getElementById('statusMsgProjetos').textContent = 'Conecte com o Google Drive.';
        return;
    }
    document.getElementById('statusMsgProjetos').textContent = 'Carregando arquivos...';
    async function buscarArquivos(pastaId) {
        const query = `'${pastaId}' in parents and (mimeType='application/pdf' or mimeType='image/png' or mimeType='text/html')`;
        const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType,webViewLink,createdTime)&orderBy=createdTime desc`;
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } });
        const data = await resp.json();
        return data.files || [];
    }
    try {
        const arquivosUsuario = await buscarArquivos(PASTA_RELATORIOS_ID);
        let htmlUsuario = '<ul>';
        arquivosUsuario.forEach(arq => {
            let icon = arq.mimeType === "application/pdf" ? "üìÑ" :
                       arq.mimeType === "image/png" ? "üñºÔ∏è" :
                       arq.mimeType === "text/html" ? "üåê" : "üìÑ";
            htmlUsuario += `<li>
                ${icon} <a href=\"${arq.webViewLink}\" target=\"_blank\">${arq.name}</a>
                <span style=\"color:#9bbdfa; font-size:0.92rem;\"> (${new Date(arq.createdTime).toLocaleString()})</span>
                <button onclick=\"excluirArquivoDrive('${arq.id}', this)\" title=\"Excluir\" class=\"del-btn\">üóëÔ∏è</button>
            </li>`;
        });
        htmlUsuario += '</ul>';
        document.getElementById('listaArquivosProjetosUsuario').innerHTML = htmlUsuario;
        document.getElementById('statusMsgProjetos').textContent = '';
    } catch (e) {
        document.getElementById('statusMsgProjetos').textContent = 'Erro ao buscar arquivos.';
    }
}
async function excluirArquivoDrive(fileId, btn) {
    if (!confirm('Tem certeza que deseja excluir este arquivo?')) return;
    if (!accessToken) { alert("N√£o autenticado!"); return; }
    btn.disabled = true;
    try {
        let resp = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}`,
            {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + accessToken }
            }
        );
        if (resp.status === 204) {
            alert('Arquivo exclu√≠do!');
            listarArquivosReunioes && listarArquivosReunioes();
            listarArquivosProjetos && listarArquivosProjetos();
        } else {
            alert('Erro ao excluir.');
        }
    } catch (e) {
        alert('Erro ao excluir arquivo.');
    }
    btn.disabled = false;
}
/* --- SERVICE WORKER --- */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(function() {
        console.log('Service Worker registrado');
      });
}
</script>
</body>
</html>
