<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>FullJob Gravador de Áudio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ... (mantém todo seu CSS) ... */
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <!-- ... (mantém todo seu HTML até o script) ... -->

<script>
  // ======= CONFIGURAÇÕES =======
  const MAX_AUDIO_MB = 20; // Limite em MB (edite se quiser)
  const MAX_AUDIO_BYTES = MAX_AUDIO_MB * 1024 * 1024;

  // == Google Drive OAuth2 Config ==
  const CLIENT_ID = '1078695213241-k5h9kpca2vfdbj52eu1n9qgn7as995fa.apps.googleusercontent.com';
  const API_KEY   = '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';
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';
  const PASTA_ID = '1ll1gBwCisRkDv1yv-mYQONa2DckYL4hG';
  const WEBHOOK_URL = "https://hook.us2.make.com/xf86x73qs3hfdisdc4vc2xxfww6dxyri";

  let btnGravar, btnPausar, btnParar, btnDownload, btnGoogleDrive, audioPlayer, statusMsg;
  let modalGravador, btnCloseGravador;
  let mediaRecorder, audioChunks = [], audioBlob = null;
  let audioContext = null, analyser = null, source = null, visualizerAnimationId = null;
  let gravando = false, tamanhoAcumulado = 0;
  let driveAuthReady = false, accessToken = '';

  window.onload = function() {
    btnGravar = document.getElementById('btnGravar');
    btnPausar = document.getElementById('btnPausar');
    btnParar = document.getElementById('btnParar');
    btnDownload = document.getElementById('btnDownload');
    btnGoogleDrive = document.getElementById('btnGoogleDrive');
    audioPlayer = document.getElementById('audioPlayer');
    statusMsg = document.getElementById('statusMsg');
    modalGravador = document.getElementById('modalGravador');
    btnCloseGravador = document.getElementById('btnCloseGravador');
    document.getElementById('cardGravar').onclick = abrirGravador;
    btnCloseGravador.onclick = fecharGravador;
    btnGravar.onclick = iniciarGravacao;
    btnPausar.onclick = pausarGravacao;
    btnParar.onclick = pararGravacao;
    btnDownload.onclick = baixarAudio;
    btnGoogleDrive.onclick = salvarGoogleDriveEWebhook;
  };

  function abrirGravador() {
    modalGravador.classList.add('open');
    resetarGravador();
  }

  function fecharGravador() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    modalGravador.classList.remove('open');
    resetarGravador();
    pararVisualizador();
  }

  function resetarGravador() {
    btnGravar.disabled = false;
    btnPausar.disabled = true;
    btnParar.disabled  = true;
    audioPlayer.src = "";
    audioPlayer.style.display = 'none';
    btnDownload.style.display = 'none';
    btnGoogleDrive.style.display = 'none';
    statusMsg.textContent     = '';
    audioChunks = [];
    audioBlob = null;
    gravando = false;
    tamanhoAcumulado = 0;
  }

  function iniciarGravacao() {
    if (!navigator.mediaDevices || !window.MediaRecorder) {
      alert("Seu navegador não suporta gravação de áudio!");
      return;
    }

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      let mimeType = 'audio/webm;codecs=opus';
      if (!MediaRecorder.isTypeSupported(mimeType)) {
        mimeType = 'audio/mp4'; // fallback iOS/Safari
      }
      mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
      audioChunks = [];
      tamanhoAcumulado = 0;
      gravando = true;
      iniciarVisualizador(stream);

      mediaRecorder.ondataavailable = e => {
        if (!e.data.size) return;
        audioChunks.push(e.data);
        tamanhoAcumulado += e.data.size;
        // Parar automaticamente se passou de 20MB
        if (tamanhoAcumulado >= MAX_AUDIO_BYTES && gravando) {
          gravando = false;
          btnPausar.disabled = true;
          btnParar.disabled = true;
          statusMsg.textContent = 'Tamanho máximo atingido (' + MAX_AUDIO_MB + ' MB). Salvando...';
          setTimeout(() => { alert('Sua gravação foi interrompida pois atingiu o limite de ' + MAX_AUDIO_MB + ' MB.'); }, 200);
          mediaRecorder.stop();
        }
      };

      mediaRecorder.onstart  = () => {
        btnGravar.disabled = true;
        btnPausar.disabled = false;
        btnParar.disabled  = false;
        statusMsg.textContent = `Gravando... (máx. ${MAX_AUDIO_MB} MB)`;
        audioPlayer.style.display = 'none';
        btnDownload.style.display = 'none';
        btnGoogleDrive.style.display = 'none';
      };

      mediaRecorder.onpause  = () => statusMsg.textContent = 'Gravação pausada.';
      mediaRecorder.onresume = () => statusMsg.textContent = 'Gravando...';

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
        statusMsg.textContent =
          'Gravação finalizada. Baixe ou envie para o Google Drive abaixo.';
        audioPlayer.src  = URL.createObjectURL(audioBlob);
        audioPlayer.style.display = 'block';
        btnDownload.style.display = 'block';
        btnGoogleDrive.style.display = 'block';
        pararVisualizador();
      };

      mediaRecorder.start();
    }).catch(err => {
      console.error('Erro ao acessar microfone:', err);
      statusMsg.textContent = 'Erro: Não foi possível acessar o microfone.';
    });
  }

  function pausarGravacao() {
    if (!mediaRecorder) return;
    if (mediaRecorder.state === 'recording') {
      mediaRecorder.pause();
      btnPausar.textContent = "▶️ Retomar";
    } else if (mediaRecorder.state === 'paused') {
      mediaRecorder.resume();
      btnPausar.textContent = "⏸️ Pausar";
    }
  }

  function pararGravacao() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      gravando = false;
      mediaRecorder.stop();
      btnGravar.disabled = false;
      btnPausar.disabled = true;
      btnParar.disabled  = true;
    }
  }

  function baixarAudio() {
    if (!audioBlob) return;
    const url = URL.createObjectURL(audioBlob);
    const a = document.createElement('a');
    a.style.display = 'none';
    const ext = audioBlob.type.includes('webm') ? 'webm' : 'm4a';
    a.href = url;
    a.download = `gravacao_${new Date().toISOString().replace(/[:.]/g,'-')}.${ext}`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }, 200);
    statusMsg.textContent = 'Arquivo baixado!';
  }

  // Função combinada: salva no Google Drive e envia Webhook para o Make
  function salvarGoogleDriveEWebhook() {
    if (!audioBlob) {
      alert('Nenhum áudio disponível para enviar!');
      return;
    }
    statusMsg.textContent = 'Conectando ao Google Drive...';

    // Gera o nome do arquivo uma vez só, para os dois usos
    const nomeArquivo = `gravacao_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`;

    ensureDriveAuth(async function() {
      statusMsg.textContent = 'Enviando para o Google Drive...';

      const metadata = {
        name: nomeArquivo,
        mimeType: audioBlob.type,
        parents: PASTA_ID ? [PASTA_ID] : undefined
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', audioBlob);

      let driveResult = {};
      try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,mimeType,webViewLink', {
          method: 'POST',
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form,
        });
        driveResult = await response.json();
        if(driveResult.id){
          statusMsg.innerHTML = 'Enviado ao Google Drive! <a href="' + driveResult.webViewLink + '" target="_blank">Abrir arquivo</a>';
        }else{
          statusMsg.textContent = 'Falha ao enviar: ' + (driveResult.error && driveResult.error.message ? driveResult.error.message : 'Erro desconhecido');
        }
      } catch(e){
        statusMsg.textContent = 'Erro na conexão com o Google Drive.';
      }

      // Agora envia o Webhook apenas com metadados (sem o arquivo base64)
      statusMsg.textContent += '\nEnviando metadados via Webhook...';

      fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          file_id: driveResult.id || null,
          webViewLink: driveResult.webViewLink || null,
          filename: driveResult.name || nomeArquivo,
          mimeType: driveResult.mimeType || audioBlob.type,
          tamanho: audioBlob.size || null,
          status: (driveResult.id ? "OK" : "ERRO"),
        })
      })
      .then(r => {
        if (r.ok) {
          statusMsg.innerHTML += '<br>Metadados enviados ao Make!';
        } else {
          statusMsg.innerHTML += '<br>Falha ao enviar metadados para o Make.';
        }
      })
      .catch(() => {
        statusMsg.innerHTML += '<br>Erro na conexão com o webhook do Make.';
      });
    });
  }

  // === Google Auth ===
  function ensureDriveAuth(callback) {
    gapi.load('client', () => {
      gapi.client.init({ apiKey: API_KEY }).then(() => {
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp && resp.access_token) {
              accessToken = resp.access_token;
              callback();
            } else {
              statusMsg.textContent = 'Falha ao autenticar no Google Drive.';
            }
          }
        });
        tokenClient.requestAccessToken({ prompt: 'select_account' });
      });
    });
  }

  // === Visualização gráfica ===
  function iniciarVisualizador(stream) {
    const canvas = document.getElementById('audioVisualizer');
    const canvasCtx = canvas.getContext('2d');
    canvas.style.display = 'block';

    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 64;

    source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);

    function desenhar() {
      visualizerAnimationId = requestAnimationFrame(desenhar);
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);

      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

      const barWidth = (canvas.width / bufferLength) - 2;
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = dataArray[i] / 2;
        canvasCtx.fillStyle = '#3576f6';
        canvasCtx.fillRect(i * (barWidth + 2), canvas.height - barHeight, barWidth, barHeight);
      }
    }
    desenhar();
  }

  function pararVisualizador() {
    const canvas = document.getElementById('audioVisualizer');
    if (visualizerAnimationId) cancelAnimationFrame(visualizerAnimationId);
    canvas.style.display = 'none';
    if (audioContext) {
      audioContext.close();
      audioContext = null;
    }
    analyser = null;
    source = null;
  }
</script>
</body>
</html>
