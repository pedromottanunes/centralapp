<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>FullJob Gravador de √Åudio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Arial,sans-serif;background:#f8f9fa;min-height:100vh;display:flex;flex-direction:column}
    .container{width:100%;max-width:375px;margin:0 auto 90px auto;flex:1;display:flex;flex-direction:column;align-items:center}
    .settings-header{width:90%;display:flex;justify-content:space-between;align-items:center;margin:28px 0 18px}
    .settings-title{font-size:2rem;font-weight:600;color:#222}
    .profile-pic{width:38px;height:38px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px #e4e4e4}
    .settings-grid{display:grid;grid-template-columns:1fr;gap:18px;width:90%;margin-bottom:32px}
    .settings-card{background:#fff;border-radius:18px;box-shadow:0 2px 8px rgba(75,0,160,.07);padding:22px 0 12px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:box-shadow .13s}
    .settings-card:hover{box-shadow:0 4px 18px rgba(75,0,160,.12)}
    .icon{width:40px;height:40px;margin-bottom:12px;background:#7e44e6;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.6rem}
    .label{font-size:1rem;font-weight:500;color:#252525;text-align:center}
    .modal-bg{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:99}
    .modal-bg.open{display:flex}
    .modal-main{background:#fff;padding:24px;border-radius:20px;box-shadow:0 2px 24px rgba(40,70,140,.15);max-width:95vw;width:320px;display:flex;flex-direction:column;align-items:center;gap:14px;position:relative}
    .close-btn{position:absolute;right:14px;top:14px;border:none;background:none;font-size:1.5rem;color:#888;cursor:pointer}
    .btn{background:#3576f6;color:#fff;border:none;border-radius:18px;padding:10px 22px;font-size:1rem;font-weight:500;cursor:pointer;box-shadow:0 2px 8px rgba(53,118,246,.1)}
    .btn:hover{background:#2254a6}
    .status-msg{font-size:.95rem;color:#2254a6;text-align:center}
    .audio-player{width:100%;margin-top:10px}
    .btn-google{background:#fff;color:#3576f6;border:2px solid #bcd4f6;}
    .btn-google:hover{background:#e3eefd;}
  </style>
  <!-- GOOGLE CLIENT LIBS -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div class="container">
    <div class="settings-header">
      <span class="settings-title">Gravador de Reuni√£o</span>
      <div id="logoArea" style="cursor:pointer;display:flex;flex-direction:column;align-items:center;">
        <img id="profileLogo" class="profile-pic" src="https://drive.google.com/thumbnail?id=1xG9c2LJaXOM6O6vLhU-8zt_rTl272tbg" alt="Logo">
        <span id="userNameSpan" style="font-size:0.8rem;color:#666;margin-top:2px;"></span>
      </div>
    </div>
    <div class="settings-grid">
      <div class="settings-card" id="cardGravar">
        <div class="icon">üé§</div>
        <div class="label">Gravar √Åudio</div>
      </div>
    </div>
  </div>

  <!-- MODAL GRAVADOR DE √ÅUDIO -->
  <div class="modal-bg" id="modalGravador">
    <div class="modal-main">
      <button class="close-btn" id="btnCloseGravador" type="button">&times;</button>
      <h3>Gravador de √Åudio</h3>
      <canvas id="audioVisualizer" width="280" height="46" style="margin:12px 0 10px 0; display:none; background:#f4f8fc; border-radius:14px;"></canvas>
      <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
        <button class="btn" id="btnGravar" type="button">‚è∫Ô∏è Gravar</button>
        <button class="btn" id="btnPausar" type="button" disabled>‚è∏Ô∏è Pausar</button>
        <button class="btn" id="btnParar" type="button" disabled>‚èπÔ∏è Parar</button>
      </div>
      <audio id="audioPlayer" class="audio-player" controls style="display:none;"></audio>
      <button class="btn" id="btnDownload"
        style="width:100%;display:none;background:#eaeaea;color:#222;"
        type="button">‚¨áÔ∏è Baixar no dispositivo</button>
      <button class="btn btn-google" id="btnGoogleDrive" style="width:100%;display:none;" type="button">‚¨ÜÔ∏è Salvar no Google Drive</button>
      <div id="statusMsg" class="status-msg"></div>
    </div>
  </div>

<script>
  // ======= CONFIGURA√á√ïES =======
  const MAX_AUDIO_MB = 20;
  const MAX_AUDIO_BYTES = MAX_AUDIO_MB * 1024 * 1024;

  // == Google Drive OAuth2 Config (Preencha com seu CLIENT_ID e API_KEY) ==
  const CLIENT_ID = '1078695213241-k5h9kpca2vfdbj52eu1n9qgn7as995fa.apps.googleusercontent.com';
  const API_KEY   = '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';
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';
  const PASTA_ID = '1ll1gBwCisRkDv1yv-mYQONa2DckYL4hG'; // OU null para raiz

  // =============================

  let btnGravar, btnPausar, btnParar, btnDownload, btnGoogleDrive, audioPlayer, statusMsg;
  let modalGravador, btnCloseGravador;
  let mediaRecorder, audioChunks = [], audioBlob = null;
  let audioContext = null, analyser = null, source = null, visualizerAnimationId = null;
  let gravando = false, tamanhoAcumulado = 0;
  let driveAuthReady = false, accessToken = '';

  window.onload = function() {
    btnGravar = document.getElementById('btnGravar');
    btnPausar = document.getElementById('btnPausar');
    btnParar = document.getElementById('btnParar');
    btnDownload = document.getElementById('btnDownload');
    btnGoogleDrive = document.getElementById('btnGoogleDrive');
    audioPlayer = document.getElementById('audioPlayer');
    statusMsg = document.getElementById('statusMsg');
    modalGravador = document.getElementById('modalGravador');
    btnCloseGravador = document.getElementById('btnCloseGravador');
    document.getElementById('cardGravar').onclick = abrirGravador;
    btnCloseGravador.onclick = fecharGravador;
    btnGravar.onclick = iniciarGravacao;
    btnPausar.onclick = pausarGravacao;
    btnParar.onclick = pararGravacao;
    btnDownload.onclick = baixarAudio;
    btnGoogleDrive.onclick = enviarParaGoogleDrive;
  };

  function abrirGravador() {
    modalGravador.classList.add('open');
    resetarGravador();
  }

  function fecharGravador() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    modalGravador.classList.remove('open');
    resetarGravador();
    pararVisualizador();
  }

  function resetarGravador() {
    btnGravar.disabled = false;
    btnPausar.disabled = true;
    btnParar.disabled  = true;
    audioPlayer.src = "";
    audioPlayer.style.display = 'none';
    btnDownload.style.display = 'none';
    btnGoogleDrive.style.display = 'none';
    statusMsg.textContent     = '';
    audioChunks = [];
    audioBlob = null;
    gravando = false;
    tamanhoAcumulado = 0;
  }

  function iniciarGravacao() {
    if (!navigator.mediaDevices || !window.MediaRecorder) {
      alert("Seu navegador n√£o suporta grava√ß√£o de √°udio!");
      return;
    }

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      let mimeType = 'audio/webm;codecs=opus';
      if (!MediaRecorder.isTypeSupported(mimeType)) {
        mimeType = 'audio/mp4'; // fallback iOS/Safari
      }
      mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
      audioChunks = [];
      tamanhoAcumulado = 0;
      gravando = true;
      iniciarVisualizador(stream);

      mediaRecorder.ondataavailable = e => {
        if (!e.data.size) return;
        audioChunks.push(e.data);
        tamanhoAcumulado += e.data.size;
        // Parar automaticamente se passou de 20MB
        if (tamanhoAcumulado >= MAX_AUDIO_BYTES && gravando) {
          gravando = false;
          statusMsg.textContent = 'Tamanho m√°ximo atingido (20 MB). Salvando...';
          mediaRecorder.stop();
        }
      };

      mediaRecorder.onstart  = () => {
        btnGravar.disabled = true;
        btnPausar.disabled = false;
        btnParar.disabled  = false;
        statusMsg.textContent = `Gravando... (m√°x. ${MAX_AUDIO_MB} MB)`;
        audioPlayer.style.display = 'none';
        btnDownload.style.display = 'none';
        btnGoogleDrive.style.display = 'none';
      };

      mediaRecorder.onpause  = () => statusMsg.textContent = 'Grava√ß√£o pausada.';
      mediaRecorder.onresume = () => statusMsg.textContent = 'Gravando...';

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
        statusMsg.textContent =
          'Grava√ß√£o finalizada. Baixe ou envie para o Google Drive abaixo.';
        audioPlayer.src  = URL.createObjectURL(audioBlob);
        audioPlayer.style.display = 'block';
        btnDownload.style.display = 'block';
        btnGoogleDrive.style.display = 'block';
        pararVisualizador();
      };

      mediaRecorder.start();
    }).catch(err => {
      console.error('Erro ao acessar microfone:', err);
      statusMsg.textContent = 'Erro: N√£o foi poss√≠vel acessar o microfone.';
    });
  }

  function pausarGravacao() {
    if (!mediaRecorder) return;
    if (mediaRecorder.state === 'recording') {
      mediaRecorder.pause();
      btnPausar.textContent = "‚ñ∂Ô∏è Retomar";
    } else if (mediaRecorder.state === 'paused') {
      mediaRecorder.resume();
      btnPausar.textContent = "‚è∏Ô∏è Pausar";
    }
  }

  function pararGravacao() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      gravando = false;
      mediaRecorder.stop();
      btnGravar.disabled = false;
      btnPausar.disabled = true;
      btnParar.disabled  = true;
    }
  }

  function baixarAudio() {
    if (!audioBlob) return;
    const url = URL.createObjectURL(audioBlob);
    const a = document.createElement('a');
    a.style.display = 'none';
    const ext = audioBlob.type.includes('webm') ? 'webm' : 'm4a';
    a.href = url;
    a.download = `gravacao_${new Date().toISOString().replace(/[:.]/g,'-')}.${ext}`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }, 200);
    statusMsg.textContent = 'Arquivo baixado!';
  }

  // === Google Drive Upload (OAuth 2) ===
  function enviarParaGoogleDrive() {
    if (!audioBlob) {
      alert('Nenhum √°udio dispon√≠vel para enviar!');
      return;
    }
    statusMsg.textContent = 'Conectando ao Google Drive...';

    ensureDriveAuth(async function() {
      statusMsg.textContent = 'Enviando para o Google Drive...';

      const metadata = {
        name: `gravacao_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`,
        mimeType: audioBlob.type,
        parents: PASTA_ID ? [PASTA_ID] : undefined
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', audioBlob);

      try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
          method: 'POST',
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form,
        });
        const result = await response.json();
        if(result.id){
          statusMsg.innerHTML = 'Enviado ao Google Drive! <a href="' + result.webViewLink + '" target="_blank">Abrir arquivo</a>';
        }else{
          statusMsg.textContent = 'Falha ao enviar: ' + (result.error && result.error.message ? result.error.message : 'Erro desconhecido');
        }
      } catch(e){
        statusMsg.textContent = 'Erro na conex√£o com o Google Drive.';
      }
    });
  }


function ensureDriveAuth(callback) {
  // Sempre mostra a tela de escolha de conta
  gapi.load('client', () => {
    gapi.client.init({ apiKey: API_KEY }).then(() => {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            callback();
          } else {
            statusMsg.textContent = 'Falha ao autenticar no Google Drive.';
          }
        }
      });
      // SEMPRE for√ßa prompt de escolha de conta
      tokenClient.requestAccessToken({ prompt: 'select_account' });
    });
  });
}


  // === Visualiza√ß√£o gr√°fica ===
  function iniciarVisualizador(stream) {
    const canvas = document.getElementById('audioVisualizer');
    const canvasCtx = canvas.getContext('2d');
    canvas.style.display = 'block';

    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 64;

    source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);

    function desenhar() {
      visualizerAnimationId = requestAnimationFrame(desenhar);
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);

      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

      const barWidth = (canvas.width / bufferLength) - 2;
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = dataArray[i] / 2;
        canvasCtx.fillStyle = '#3576f6';
        canvasCtx.fillRect(i * (barWidth + 2), canvas.height - barHeight, barWidth, barHeight);
      }
    }
    desenhar();
  }

  function pararVisualizador() {
    const canvas = document.getElementById('audioVisualizer');
    if (visualizerAnimationId) cancelAnimationFrame(visualizerAnimationId);
    canvas.style.display = 'none';
    if (audioContext) {
      audioContext.close();
      audioContext = null;
    }
    analyser = null;
    source = null;
  }
</script>
</body>
</html>
